<?php

session_start();

require('../models/model.php');

include_once('../includes/inc_functions.php');

$id = $_SESSION['id'];

$req_histo_point = histoPointage($id);

$nbLignes = $req_histo_point->rowCount();

$nbLignesPage = 10;

$nbPages = ceil($nbLignes / $nbLignesPage);

$tabResult = $req_histo_point->fetchAll(PDO::FETCH_ASSOC);


///////////////////////////////////////////////////////////////////////////////////////////////
///// Construction du tableau pour affichage de l'historique avec cumul des soldes horaires
///////////////////////////////////////////////////////////////////////////////////////////////

$cumul = 0;

for ($i=0; $i < $nbLignes; $i++) {

    $date = $tabResult[$i]['Date']; //formatDate(inverseDate())
    $h_arrivee = $tabResult[$i]['Heure Arrivée'];
    $h_depart = $tabResult[$i]['Heure Départ']; //substr(,0,5)
    $pause = $tabResult[$i]['Pause méridienne'];
    $mod_horaire = $tabResult[$i]['Module horaire'];
    $temps_realise = $tabResult[$i]['Temps réalisé'];
    $point_id = $tabResult[$i]['point_id'];
    
    $solde = calculerCredit(timeTosecond($h_arrivee), timeTosecond($h_depart), timeTosecond($pause), timeTosecond($mod_horaire));

    if ($solde[0] == "-") {
        $soldeAbs =substr($solde,1);
        $cumul -= timeTosecond($soldeAbs);
    } else {
        $cumul += timeTosecond($solde);
    }
    
    $format_cumul = gmdate('H:i', $cumul);

    $tab [] = array ($date, $h_arrivee, $h_depart, $mod_horaire, $temps_realise, $solde, $format_cumul, $point_id); //$pause
}

if (!empty($tab)) {
    $tab = array_reverse($tab);
}


///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////
////Gestion des pages
///////////////////////////////////////////////////////////////////////////////////////////////

if (isset($_GET['page']) && !empty($_GET['page'])) { 
    $pageActuelle = intval($_GET['page']);

    if ($pageActuelle > $nbPages) // Si la valeur de $pageActuelle (le numéro de la page) est plus grande que $nombreDePages...
    {
        $pageActuelle = $nbPages;
    }
} else {
    $pageActuelle = 1; // La page actuelle est la n°1    
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////
////Gestion des lignes
///////////////////////////////////////////////////////////////////////////////////////////////

$firstLine = ($pageActuelle - 1) * $nbLignesPage;
$lastLine = ($pageActuelle * $nbLignesPage) - 1;

if ($lastLine >= $nbLignes) {
    $lastLine = $lastLine - ($lastLine - $nbLignes) - 1;
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////
////Edition d'un pointage pour modification
///////////////////////////////////////////////////////////////////////////////////////////////

if (isset($_GET['editer'])) {   
    $edit_id = $_GET['editer'];
    $_SESSION['edit_id'] = $edit_id;
    redirection('modif_pointage.php');
  }

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////


require('../views/view_histo_point.php');
